<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Cr√©er un Acc√®s - Infrabel</title>
    <style>
        /* RESET ET VARIABLES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066b3;
            --primary-dark: #004c8c;
            --primary-light: #e3f2fd;
            --secondary: #2c3e50;
            --success: #2ecc71;
            --success-dark: #27ae60;
            --danger: #e74c3c;
            --danger-dark: #c0392b;
            --warning: #f39c12;
            --warning-dark: #d68910;
            --info: #3498db;
            --info-dark: #2980b9;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 15px rgba(0,102,179,0.2);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(145deg, #f6f9fc 0%, #edf2f7 100%);
            color: var(--gray-800);
            font-size: 16px;
            line-height: 1.5;
            padding: 24px;
            min-height: 100vh;
        }

        /* LAYOUT */
        .app-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* HEADER */
        .app-header {
            text-align: center;
            margin-bottom: 32px;
            position: relative;
        }

        .brand {
            background: white;
            padding: 28px 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .brand::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--info), var(--success));
        }

        h1 {
            color: var(--secondary);
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        h1 span {
            background: linear-gradient(145deg, var(--primary), var(--info-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--gray-600);
            font-size: 0.95rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-top: 1px solid var(--gray-200);
            padding-top: 16px;
            margin-top: 8px;
        }

        .badge-version {
            display: inline-block;
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 12px;
            border: 1px solid var(--primary);
        }

        /* BOUTON RETOUR */
        .btn-back {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 100;
            background: white;
            color: var(--gray-700);
            padding: 12px 24px;
            border: 1px solid var(--gray-300);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-sm);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-back:hover {
            background: var(--gray-100);
            transform: translateX(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--gray-400);
        }

        /* CONTAINER PRINCIPAL */
        .main-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 36px;
            margin-bottom: 30px;
        }

        /* CARTE FORMULAIRE */
        .form-card {
            background: white;
        }

        .form-title {
            font-size: 1.8rem;
            color: var(--secondary);
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 3px solid var(--primary-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-title i {
            font-size: 1.8rem;
        }

        /* INFOBOX */
        .info-box {
            background: linear-gradient(145deg, #fff8e7, #fff3d9);
            border-left: 6px solid var(--warning);
            padding: 20px 24px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 32px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
            box-shadow: var(--shadow-sm);
        }

        .info-box-icon {
            font-size: 1.8rem;
            line-height: 1;
        }

        .info-box-content {
            flex: 1;
        }

        .info-box-title {
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .info-box-text {
            color: var(--gray-700);
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .info-box-list {
            list-style: none;
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .info-box-list li {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        /* FORMULAIRES */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px 32px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .required label::after {
            content: ' *';
            color: var(--danger);
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: white;
        }

        input:hover, select:hover, textarea:hover {
            border-color: var(--gray-400);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 102, 179, 0.1);
        }

        .input-hint {
            font-size: 0.8rem;
            color: var(--gray-600);
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ROW POUR SELECTS */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 12px;
        }

        .location-preview {
            margin-top: 16px;
            padding: 16px 20px;
            background: var(--primary-light);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 1rem;
            word-break: break-word;
        }

        .location-preview i {
            font-size: 1.2rem;
        }

        .location-preview.empty {
            background: var(--gray-100);
            border-color: var(--gray-300);
            color: var(--gray-600);
            font-weight: normal;
        }

        /* SECTION COORDONN√âES */
        .coords-group {
            background: var(--gray-100);
            padding: 24px;
            border-radius: var(--border-radius-sm);
            margin-top: 16px;
        }

        .coords-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .coords-title {
            font-weight: 700;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-location {
            background: var(--info);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-location:hover {
            background: var(--info-dark);
            transform: scale(1.02);
            box-shadow: var(--shadow-hover);
        }

        /* BOUTONS D'ACTION */
        .form-actions {
            display: flex;
            gap: 20px;
            margin-top: 36px;
            padding-top: 24px;
            border-top: 2px solid var(--gray-200);
            flex-wrap: wrap;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
            min-width: 200px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(0, 102, 179, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 102, 179, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
            transform: translateY(-2px);
        }

        .btn i {
            font-size: 1.1rem;
        }

        /* NOTIFICATIONS */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: var(--border-radius-sm);
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 450px;
            width: calc(100% - 48px);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification.success { background: linear-gradient(145deg, var(--success), var(--success-dark)); }
        .notification.error { background: linear-gradient(145deg, var(--danger), var(--danger-dark)); }
        .notification.info { background: linear-gradient(145deg, var(--info), var(--info-dark)); }
        .notification.warning { background: linear-gradient(145deg, var(--warning), var(--warning-dark)); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* LOADING SPINNER */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--gray-200);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* MESSAGES D'ERREUR INLINE */
        .error-message {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* RESPONSIVE */
        @media (max-width: 992px) {
            body { padding: 16px; }
            .main-container { padding: 28px; }
            .form-grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.9rem; }
        }

        @media (max-width: 768px) {
            .btn-back {
                position: static;
                width: 100%;
                margin-bottom: 16px;
                justify-content: center;
            }

            .brand { padding: 20px; }
            h1 { font-size: 1.6rem; flex-direction: column; gap: 8px; }

            .main-container { padding: 20px; }

            .form-title { font-size: 1.5rem; }

            .info-box { flex-direction: column; }

            .form-row { grid-template-columns: 1fr; }

            .form-actions { flex-direction: column; }
            .btn { width: 100%; }

            .coords-header { flex-direction: column; gap: 16px; align-items: flex-start; }
            .btn-location { width: 100%; justify-content: center; }

            .notification {
                top: 16px;
                right: 16px;
                left: 16px;
                width: auto;
            }
        }

        @media (max-width: 480px) {
            body { padding: 12px; }
            .main-container { padding: 16px; }
            h1 { font-size: 1.4rem; }
            .badge-version { font-size: 0.7rem; }

            .info-box-list { flex-direction: column; gap: 8px; }

            .location-preview { flex-direction: column; text-align: center; }
        }

        /* UTILITAIRES */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 24px; }
    </style>
</head>
<body>
<div class="app-wrapper">
    <!-- Bouton Retour -->
    <button class="btn-back" onclick="window.location.href='/infrabel/index.html'">
        <span>‚Üê</span> Retour au menu
    </button>

    <!-- En-t√™te -->
    <header class="app-header">
        <div class="brand">
            <h1>
                <span>‚ûï</span> Cr√©er un nouvel acc√®s
            </h1>
            <div class="subtitle">
                INFRASTRUCTURE FERROVIAIRE ‚Ä¢ GESTION DES ACC√àS
            </div>
            <span class="badge-version">
                    ‚ö° BK √©tendu √† 300km ‚Ä¢ Indices 0-9 & A-Z
                </span>
        </div>
    </header>

    <!-- Conteneur principal -->
    <div class="main-container">
        <div class="form-card">
            <div class="form-title">
                <span>üìã</span> Formulaire de cr√©ation
            </div>

            <!-- Bo√Æte d'information -->
            <div class="info-box">
                <div class="info-box-icon">‚ÑπÔ∏è</div>
                <div class="info-box-content">
                    <div class="info-box-title">Nouveau syst√®me de localisation</div>
                    <div class="info-box-text">Format standardis√© : Ligne + indice optionnel + BK + BH optionnel</div>
                    <ul class="info-box-list">
                        <li>‚úì Lignes: 0 √† 100</li>
                        <li>‚úì Indices: 0-9 et A-Z</li>
                        <li>‚úì BK: 0 √† 300 km</li>
                        <li>‚úì BH: 0 √† 900 m (pas de 100m)</li>
                    </ul>
                </div>
            </div>

            <!-- Formulaire -->
            <form id="createAccessForm" novalidate>
                <div class="form-grid">
                    <!-- Nom d'acc√®s -->
                    <div class="form-group required full-width">
                        <label for="nomAcces">Nom d'acc√®s</label>
                        <input
                                type="text"
                                id="nomAcces"
                                name="nomAcces"
                                placeholder="Ex: Acc√®s chantier Ligne 36B"
                                maxlength="255"
                                required
                        >
                        <div class="input-hint">
                            <span>üî§</span> Nom unique identifiant l'acc√®s
                        </div>
                    </div>

                    <!-- Localisation ferroviaire -->
                    <div class="form-group required full-width">
                        <label>Localisation ferroviaire</label>
                        <div class="form-row">
                            <select id="ligne" name="ligne" required>
                                <option value="">üöÜ Ligne</option>
                                <!-- Rempli dynamiquement -->
                            </select>

                            <select id="indice" name="indice">
                                <option value="">üî£ Indice (optionnel)</option>
                                <!-- Rempli dynamiquement -->
                            </select>

                            <select id="bk" name="bk" required>
                                <option value="">üìè BK (km)</option>
                                <!-- Rempli dynamiquement -->
                            </select>

                            <select id="bh" name="bh">
                                <option value="">üéØ BH (m) - optionnel</option>
                                <!-- Rempli dynamiquement -->
                            </select>
                        </div>

                        <!-- Champ cach√© pour la valeur combin√©e -->
                        <input type="hidden" id="ligneBkVoie" name="ligneBkVoie">

                        <!-- Aper√ßu de la localisation -->
                        <div id="locationPreview" class="location-preview empty">
                            <span>üìç</span> Aucune localisation d√©finie
                        </div>
                    </div>

                    <!-- Adresse postale -->
                    <div class="form-group full-width">
                        <label for="adresse">Adresse postale</label>
                        <input
                                type="text"
                                id="adresse"
                                name="adresse"
                                placeholder="Ex: Rue de la Gare 12, 1000 Bruxelles"
                        >
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label for="typeDescription">Type d'acc√®s</label>
                        <select id="typeDescription">
                            <option value="">S√©lectionnez un type</option>
                            <option value="Zone de mise √† rail">Zone de mise √† rail</option>
                            <option value="Accessible en remorque">Accessible en remorque</option>
                            <option value="Accessible en camionnette">Accessible en camionnette</option>
                            <option value="Accessible pi√©ton">Accessible pi√©ton</option>
                            <option value="Acc√®s v√©hicule l√©ger">Acc√®s v√©hicule l√©ger</option>
                            <option value="Acc√®s engins de chantier">Acc√®s engins de chantier</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="coteVoie">C√¥t√© voie</label>
                        <select id="coteVoie">
                            <option value="">S√©lectionnez c√¥t√©</option>
                            <option value="C√¥t√© Voie A">C√¥t√© Voie A</option>
                            <option value="C√¥t√© Voie B">C√¥t√© Voie B</option>

                        </select>
                        <input type="hidden" id="description" name="description">
                    </div>

                    <!-- Coordonn√©es GPS -->
                    <div class="form-group full-width">
                        <div class="coords-group">
                            <div class="coords-header">
                                    <span class="coords-title">
                                        <span>üìç</span> Coordonn√©es GPS
                                    </span>
                                <button type="button" class="btn-location" onclick="getCurrentLocation()">
                                    <span>üéØ</span> Utiliser ma position
                                </button>
                            </div>
                            <div class="form-row">
                                <div>
                                    <input
                                            type="number"
                                            id="latitude"
                                            name="latitude"
                                            placeholder="Latitude (ex: 50.846557)"
                                            step="any"
                                    >
                                </div>
                                <div>
                                    <input
                                            type="number"
                                            id="longitude"
                                            name="longitude"
                                            placeholder="Longitude (ex: 4.351697)"
                                            step="any"
                                    >
                                </div>
                            </div>
                            <div class="input-hint">
                                <span>üåç</span> Format d√©cimal, s√©parateur point
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages d'erreur/succ√®s -->
                <div id="formMessage" class="hidden"></div>

                <!-- Boutons d'action -->
                <div class="form-actions">
                    <button type="submit" id="submitBtn" class="btn btn-primary">
                        <span>üíæ</span> Cr√©er l'acc√®s
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        <span>üîÑ</span> R√©initialiser
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Overlay de chargement -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
</div>

<script>
    // Constantes
    const API_BASE_URL = '/api/acces'; // √Ä adapter selon votre contexte
    const API_ACCES_CREATE = API_BASE_URL; // POST /

    // Initialisation des listes d√©roulantes
    function initializeDropdowns() {
        // Lignes 0-100
        const ligneSelect = document.getElementById('ligne');
        ligneSelect.innerHTML = '<option value="">üöÜ Ligne</option>';
        for (let i = 0; i <= 100; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Ligne ${i}`;
            ligneSelect.appendChild(option);
        }

        // Indices 0-9 et A-Z
        const indiceSelect = document.getElementById('indice');
        indiceSelect.innerHTML = '<option value="">üî£ Indice (optionnel)</option>';

        // Chiffres 0-9
        for (let i = 0; i <= 9; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            indiceSelect.appendChild(option);
        }

        // Lettres A-Z
        for (let i = 65; i <= 90; i++) {
            const option = document.createElement('option');
            const letter = String.fromCharCode(i);
            option.value = letter;
            option.textContent = letter;
            indiceSelect.appendChild(option);
        }

        // BK 0-300 km
        const bkSelect = document.getElementById('bk');
        bkSelect.innerHTML = '<option value="">üìè BK (km)</option>';
        for (let i = 0; i <= 300; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${i} km`;
            bkSelect.appendChild(option);
        }

        // BH 0-900 (pas de 100)
        const bhSelect = document.getElementById('bh');
        bhSelect.innerHTML = '<option value="">üéØ BH (m) - optionnel</option>';
        bhSelect.appendChild(new Option('0 m (exact)', '0'));
        for (let i = 100; i <= 900; i += 100) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${i} m`;
            bhSelect.appendChild(option);
        }
    }

    // Mise √† jour de l'aper√ßu de localisation et du champ cach√©
    function updateLocationPreview() {
        const ligne = document.getElementById('ligne').value;
        const indice = document.getElementById('indice').value;
        const bk = document.getElementById('bk').value;
        const bh = document.getElementById('bh').value;

        const preview = document.getElementById('locationPreview');
        const ligneBkVoie = document.getElementById('ligneBkVoie');

        if (!ligne || !bk) {
            preview.className = 'location-preview empty';
            preview.innerHTML = '<span>üìç</span> Aucune localisation d√©finie';
            ligneBkVoie.value = '';
            return;
        }

        let locationDisplay = `Ligne ${ligne}`;
        let locationFull = `Ligne ${ligne}`;

        // Ajout de l'indice
        if (indice) {
            locationDisplay += indice;
            locationFull += indice;
        }

        // Ajout du BK et BH
        locationDisplay += ` - BK ${bk} km`;
        locationFull += ` BK ${bk}`;

        if (bh) {
            // Format BH avec 3 chiffres
            const bhFormatted = bh.toString().padStart(3, '0');
            locationDisplay += `.${bhFormatted}`;
            locationFull += `.${bhFormatted}`;
        } else {
            locationFull += '.000';
        }

        preview.className = 'location-preview';
        preview.innerHTML = `<span>üìç</span> ${locationDisplay}`;
        ligneBkVoie.value = locationFull;
    }

    // Mise √† jour de la description combin√©e
    function updateDescription() {
        const type = document.getElementById('typeDescription').value;
        const cote = document.getElementById('coteVoie').value;
        const descriptionField = document.getElementById('description');

        if (type && cote) {
            descriptionField.value = `${type} - ${cote}`;
        } else if (type) {
            descriptionField.value = type;
        } else if (cote) {
            descriptionField.value = cote;
        } else {
            descriptionField.value = '';
        }
    }

    // Validation du formulaire
    function validateForm() {
        const nomAcces = document.getElementById('nomAcces').value.trim();
        const ligne = document.getElementById('ligne').value;
        const bk = document.getElementById('bk').value;
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;

        // Supprimer les anciens messages d'erreur
        document.querySelectorAll('.error-message').forEach(el => el.remove());

        let isValid = true;
        let errorMessage = '';

        // Validation nom
        if (!nomAcces) {
            showFieldError('nomAcces', 'Le nom d\'acc√®s est obligatoire');
            isValid = false;
            errorMessage = 'Veuillez remplir tous les champs obligatoires';
        }

        // Validation ligne
        if (!ligne) {
            showFieldError('ligne', 'La ligne est obligatoire');
            isValid = false;
            errorMessage = 'Veuillez remplir tous les champs obligatoires';
        }

        // Validation BK
        if (!bk) {
            showFieldError('bk', 'Le BK est obligatoire');
            isValid = false;
            errorMessage = 'Veuillez remplir tous les champs obligatoires';
        }

        // Validation coordonn√©es (si une des deux est renseign√©e)
        if ((latitude && !longitude) || (!latitude && longitude)) {
            if (latitude && !longitude) {
                showFieldError('longitude', 'La longitude est requise si la latitude est renseign√©e');
            } else {
                showFieldError('latitude', 'La latitude est requise si la longitude est renseign√©e');
            }
            isValid = false;
            errorMessage = 'Les coordonn√©es GPS doivent √™tre compl√®tes';
        }

        if (!isValid && errorMessage) {
            showMessage(errorMessage, 'error');
        }

        return isValid;
    }

    // Afficher erreur sur un champ
    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        if (field) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<span>‚ö†Ô∏è</span> ${message}`;

            // Supprimer l'ancienne erreur si existe
            const existingError = field.parentNode.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            field.parentNode.appendChild(errorDiv);
            field.focus();
        }
    }

    // Afficher une notification
    function showNotification(message, type = 'info') {
        // Supprimer les anciennes notifications
        document.querySelectorAll('.notification').forEach(notif => notif.remove());

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;

        const icon = {
            'success': '‚úÖ',
            'error': '‚ùå',
            'warning': '‚ö†Ô∏è',
            'info': '‚ÑπÔ∏è'
        }[type] || 'üì¢';

        notification.innerHTML = `
            <span style="font-size: 1.2rem;">${icon}</span>
            <span>${message}</span>
        `;

        document.body.appendChild(notification);

        // Auto-suppression apr√®s 5 secondes
        setTimeout(() => {
            notification.style.animation = 'fadeOut 0.3s ease forwards';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }

    // Afficher message dans le formulaire
    function showMessage(message, type = 'info') {
        const messageDiv = document.getElementById('formMessage');
        messageDiv.className = `${type} show`;
        messageDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                ${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}
            </div>
        `;
        messageDiv.classList.remove('hidden');

        // Scroll jusqu'au message
        messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Chargement
    function setLoading(isLoading) {
        const overlay = document.getElementById('loadingOverlay');
        const submitBtn = document.getElementById('submitBtn');

        if (isLoading) {
            overlay.classList.add('active');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>‚è≥</span> Cr√©ation en cours...';
        } else {
            overlay.classList.remove('active');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>üíæ</span> Cr√©er l\'acc√®s';
        }
    }

    // Cr√©ation de l'acc√®s
    async function createAccess(event) {
        event.preventDefault();

        // Validation
        if (!validateForm()) {
            return;
        }

        // R√©cup√©ration des donn√©es
        const accessData = {
            nomAcces: document.getElementById('nomAcces').value.trim(),
            ligneBkVoie: document.getElementById('ligneBkVoie').value,
            adresse: document.getElementById('adresse').value.trim() || null,
            description: document.getElementById('description').value || null,
            latitude: document.getElementById('latitude').value ?
                     parseFloat(document.getElementById('latitude').value) : null,
            longitude: document.getElementById('longitude').value ?
                      parseFloat(document.getElementById('longitude').value) : null
        };

        try {
            setLoading(true);

            const response = await fetch(API_ACCES_CREATE, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(accessData)
            });

            const responseData = await response.json();

            if (!response.ok) {
                // Gestion sp√©cifique des erreurs
                if (response.status === 400 || response.status === 409) {
                    throw new Error(responseData.message || 'Donn√©es invalides');
                } else if (response.status === 500) {
                    throw new Error('Erreur serveur interne');
                } else {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
            }

            // Succ√®s
            showNotification('‚úÖ Acc√®s cr√©√© avec succ√®s !', 'success');
            showMessage('Acc√®s cr√©√© avec succ√®s ! Redirection...', 'success');

            // Redirection apr√®s 2 secondes
            setTimeout(() => {
                if (responseData.id) {
                    window.location.href = `/infrabel/access.html?id=${responseData.id}`;
                } else {
                    window.location.href = '/infrabel/index.html';
                }
            }, 2000);

        } catch (error) {
            console.error('Erreur:', error);
            showNotification(`‚ùå ${error.message}`, 'error');
            showMessage(`Erreur: ${error.message}`, 'error');
        } finally {
            setLoading(false);
        }
    }

    // G√©olocalisation
    function getCurrentLocation() {
        if (!navigator.geolocation) {
            showNotification('‚ùå G√©olocalisation non support√©e par votre navigateur', 'error');
            return;
        }

        showNotification('üìç R√©cup√©ration de votre position...', 'info');

        navigator.geolocation.getCurrentPosition(
            position => {
                const lat = position.coords.latitude.toFixed(6);
                const lng = position.coords.longitude.toFixed(6);

                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;

                showNotification('‚úÖ Position r√©cup√©r√©e avec succ√®s !', 'success');
            },
            error => {
                let message = 'Erreur de g√©olocalisation: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message += 'Veuillez autoriser l\'acc√®s √† votre position';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message += 'Position non disponible';
                        break;
                    case error.TIMEOUT:
                        message += 'D√©lai d\'attente d√©pass√©';
                        break;
                    default:
                        message += 'Erreur inconnue';
                }
                showNotification(message, 'error');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    // Reset formulaire
    function resetForm() {
        document.getElementById('createAccessForm').reset();

        // Reset des champs cach√©s et aper√ßus
        document.getElementById('ligneBkVoie').value = '';
        document.getElementById('description').value = '';

        const preview = document.getElementById('locationPreview');
        preview.className = 'location-preview empty';
        preview.innerHTML = '<span>üìç</span> Aucune localisation d√©finie';

        // Supprimer les messages d'erreur
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        document.getElementById('formMessage').classList.add('hidden');

        showNotification('üîÑ Formulaire r√©initialis√©', 'info');
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        initializeDropdowns();

        // √âcouteurs pour la localisation
        ['ligne', 'indice', 'bk', 'bh'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateLocationPreview);
        });

        // √âcouteurs pour la description
        ['typeDescription', 'coteVoie'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateDescription);
        });

        // Submit du formulaire
        const form = document.getElementById('createAccessForm');
        form.addEventListener('submit', createAccess);

        // Validation en temps r√©el pour les coordonn√©es
        const latitude = document.getElementById('latitude');
        const longitude = document.getElementById('longitude');

        [latitude, longitude].forEach(field => {
            field.addEventListener('input', function() {
                const errorMsg = this.parentNode.parentNode.querySelector('.error-message');
                if (errorMsg) errorMsg.remove();
            });
        });

        // Initialiser l'aper√ßu
        updateLocationPreview();
        updateDescription();
    });
</script>
</body>
</html>