<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Playlist</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:Arial,sans-serif;
  background:#9b59b6;
  padding:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
}

.buttons-container{
  position:fixed;
  top:20px;
  right:20px;
  display:flex;
  gap:10px;
  background:rgba(255,255,255,.95);
  padding:10px 15px;
  border-radius:15px;
  box-shadow:0 4px 20px rgba(0,0,0,.3);
  z-index:1000;
}

.buttons-container button{
  background:#fff;
  color:#8e44ad;
  border:2px solid #8e44ad;
  padding:10px 16px;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  transition:.3s;
}

.buttons-container button:hover{
  background:#8e44ad;
  color:#fff;
}

h1{
  margin:80px 0 15px;
  color:#fff;
  text-align:center;
}

.playlist-info{
  color:#fff;
  margin-bottom:20px;
  text-align:center;
}

.container{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(350px,1fr));
  gap:20px;
  width:100%;
  max-width:1200px;
}

.card{
  background:#fff;
  border-radius:16px;
  box-shadow:0 6px 20px rgba(0,0,0,.15);
  padding:20px;
  display:flex;
  flex-direction:column;
  transition:.3s;
}

.card:hover{
  transform:translateY(-6px);
}

iframe.youtube{
  width:100%;
  height:200px;
  border-radius:12px;
  border:none;
}

iframe.spotify{
  width:100%;
  height:80px;
  border-radius:8px;
  border:none;
  margin-top:10px;
}

.info{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:12px;
  gap:10px;
}

.title{
  font-weight:bold;
  color:#222;
}

.info img{
  width:60px;
  height:60px;
  border-radius:8px;
  object-fit:cover;
}

.pagination{
  margin:30px 0;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
}

.pagination button{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:#fff;
  color:#8e44ad;
  font-weight:600;
  cursor:pointer;
}

.pagination button.active,
.pagination button:hover{
  background:#8e44ad;
  color:#fff;
}

.loading{
  color:#fff;
  margin:30px;
}

.error{
  background:#fff;
  color:#e74c3c;
  padding:20px;
  border-radius:10px;
  margin:30px;
}
</style>
</head>

<body>

<div class="buttons-container">
<button onclick="history.back()">ðŸ”™ Retour</button>
<button onclick="logout()">ðŸšª DÃ©connexion</button>
</div>

<h1 id="pageTitle">ðŸŽµ Playlist</h1>
<div class="playlist-info" id="playlistInfo"></div>
<div class="loading" id="loading">Chargement...</div>
<div class="container" id="playlist"></div>
<div class="pagination" id="pagination"></div>

<script>

const OWNER = "djhustla";
const REPO = "music-storage";
const BRANCH = "main";
const FOLDER = "playlist_list";

let allSongs = [];
let currentPage = 1;
const itemsPerPage = 20;

function logout(){
  localStorage.removeItem("accessToken");
  localStorage.removeItem("refreshToken");
  alert("DÃ©connexion rÃ©ussie");
  window.location.href="/connection/connection.html";
}

async function loadPlaylist(){

  const params = new URLSearchParams(window.location.search);
  let src = decodeURIComponent(params.get("src") || "fr.txt");

  const playlistName = src.replace(".txt","");
  document.getElementById("pageTitle").textContent="ðŸŽµ "+playlistName;
  document.getElementById("playlistInfo").textContent="Lecture : "+playlistName;

  try{

    // âœ… Appel API GitHub (stable en prod)
    const apiUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FOLDER}/${src}?ref=${BRANCH}`;

    const response = await fetch(apiUrl);

    if(!response.ok) throw new Error("Fichier introuvable sur GitHub");

    const data = await response.json();

    // GitHub retourne le contenu encodÃ© en base64
    const decoded = atob(data.content);
    
    allSongs = decoded.trim().split("\n")
      .map(line=>{
        try{
          return JSON.parse(line);
        }catch{
          return null;
        }
      })
      .filter(Boolean);

    document.getElementById("loading").style.display="none";

    if(allSongs.length===0){
      document.getElementById("playlist").innerHTML=
        `<div class="error">Playlist vide</div>`;
      return;
    }

    renderPage(currentPage);
    renderPagination();

  }catch(err){
    document.getElementById("loading").style.display="none";
    document.getElementById("playlist").innerHTML=
      `<div class="error">${err.message}</div>`;
  }
}

function renderPage(page){

  const container=document.getElementById("playlist");
  container.innerHTML="";

  const start=(page-1)*itemsPerPage;
  const end=start+itemsPerPage;

  allSongs.slice(start,end).forEach(music=>{

    const card=document.createElement("div");
    card.className="card";

    let html="";

    if(music.youtubeUrl){
      const id=new URL(music.youtubeUrl).searchParams.get("v");
      if(id){
        html+=`<iframe class="youtube" src="https://www.youtube.com/embed/${id}" allowfullscreen></iframe>`;
      }
    }

    if(music.spotifyUrl){
      const embed=music.spotifyUrl.replace("track/","embed/track/");
      html+=`<iframe class="spotify" src="${embed}"></iframe>`;
    }

    html+=`
    <div class="info">
      <div class="title">${music.titreComplet || "Sans titre"}</div>
      ${music.photo ? `<img src="${music.photo}">` : ""}
    </div>`;

    card.innerHTML=html;
    container.appendChild(card);
  });
}

function renderPagination(){

  const pagination=document.getElementById("pagination");
  pagination.innerHTML="";

  const total=Math.ceil(allSongs.length/itemsPerPage);

  for(let i=1;i<=total;i++){
    const btn=document.createElement("button");
    btn.textContent=i;
    if(i===currentPage) btn.classList.add("active");

    btn.onclick=()=>{
      currentPage=i;
      renderPage(i);
      renderPagination();
      window.scrollTo({top:0,behavior:"smooth"});
    };

    pagination.appendChild(btn);
  }
}

window.addEventListener("DOMContentLoaded",loadPlaylist);

</script>

</body>
</html>
