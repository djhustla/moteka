<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fil d'Actualit√©</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 40px 20px; position: relative;
    }
    body::before {
      content: ''; position: fixed; top:0; left:0; width:100%; height:100%;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      pointer-events:none; z-index:0;
    }
    .header { text-align:center; margin-bottom:40px; position:relative; z-index:1; }
    h1 { color:white; font-size:2.5rem; font-weight:700; text-shadow:0 2px 20px rgba(0,0,0,0.2); margin-bottom:8px; letter-spacing:-0.5px; }
    .subtitle { color: rgba(255,255,255,0.9); font-size:1rem; font-weight:400; }

    .container { max-width:800px; margin:0 auto; background:white; padding:0; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; position:relative; z-index:1; }

    /* Section de publication */
    .publish-section { background:#f8fafc; padding:25px 30px; border-bottom:2px solid #e5e7eb; }
    .publish-form { display:flex; flex-direction:column; gap:15px; }
    .publish-input { width:100%; padding:15px; border:2px solid #d1d5db; border-radius:12px; font-size:1rem; resize:none; min-height:100px; font-family:inherit; transition:all 0.3s; }
    .publish-input:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102, 126, 234, 0.2); transform:translateY(-2px); }
    .publish-submit { align-self:flex-end; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; padding:12px 25px; border-radius:10px; cursor:pointer; font-weight:600; font-size:1rem; transition:all 0.3s; }
    .publish-submit:hover { transform:translateY(-2px); box-shadow:0 4px 15px rgba(102,126,234,0.4); }
    .publish-submit:disabled { background:#9ca3af; cursor:not-allowed; transform:none; box-shadow:none; }

    .messages-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:20px 30px; color:white; font-size:1.2rem; font-weight:600; border-bottom:3px solid rgba(255,255,255,0.2); }

    /* Section messages */
    #messages { padding:20px; max-height:600px; overflow-y:auto; }
    #messages::-webkit-scrollbar { width:8px; }
    #messages::-webkit-scrollbar-track { background:#f1f1f1; border-radius:10px; }
    #messages::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:10px; }

    /* Style des messages */
    .message { padding:20px; margin-bottom:25px; background:#fff; border-radius:16px; box-shadow:0 4px 15px rgba(0,0,0,0.1); border:1px solid #e5e7eb; transition:all 0.3s; }
    .message:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,0.15); }
    .message-header { display:flex; align-items:center; gap:12px; margin-bottom:15px; }
    .message-header img { width:50px; height:50px; border-radius:50%; object-fit:cover; border:3px solid #667eea; }
    .user-info { flex:1; }
    .username { font-weight:600; color:#667eea; font-size:1.1rem; }
    .time { font-size:0.8rem; color:#9ca3af; margin-top:2px; }
    .message-text { color:#333; font-size:1rem; line-height:1.6; margin-bottom:15px; padding-left:62px; }

    /* Section commentaires */
    .comments-section { margin-top:20px; padding-top:20px; border-top:1px solid #e5e7eb; }
    .comments-header { display:flex; align-items:center; gap:8px; margin-bottom:15px; color:#667eea; font-weight:600; font-size:0.9rem; }
    .comment-count { background:#667eea; color:white; padding:2px 8px; border-radius:12px; font-size:0.8rem; }

    .comment-form { display:flex; gap:10px; margin-bottom:15px; }
    .comment-input { flex:1; padding:12px 15px; border:1px solid #d1d5db; border-radius:10px; font-size:0.9rem; resize:none; min-height:45px; transition:all 0.3s; }
    .comment-input:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 2px rgba(102, 126, 234, 0.2); }
    .comment-submit { background:#667eea; color:white; border:none; padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.3s; }
    .comment-submit:hover { background:#5a6fd8; transform:translateY(-1px); }
    .comment-submit:disabled { background:#9ca3af; cursor:not-allowed; transform:none; }

    .comments-list { max-height:200px; overflow-y:auto; padding-right:5px; }
    .comment { display:flex; gap:12px; padding:12px; margin-bottom:10px; background:#f8fafc; border-radius:10px; border-left:4px solid #667eea; transition:all 0.3s; }
    .comment:hover { background:#f1f5f9; transform:translateX(2px); }
    .comment-avatar { width:35px; height:35px; border-radius:50%; object-fit:cover; border:2px solid #667eea; }
    .comment-content { flex:1; }
    .comment-author { font-weight:600; color:#667eea; font-size:0.85rem; }
    .comment-text { color:#4b5563; font-size:0.9rem; margin-top:2px; line-height:1.4; }
    .comment-time { color:#9ca3af; font-size:0.75rem; margin-top:4px; }

    /* √âtats */
    .loading { text-align:center; padding:40px; color:#667eea; font-size:1.1rem; }
    .error { text-align:center; padding:40px; color:#ef4444; font-size:1.1rem; background:#fee; border-radius:12px; margin:20px; }
    .empty-state { text-align:center; padding:60px 20px; color:#9ca3af; }
    .empty-state::before { content:'üì≠'; display:block; font-size:4rem; margin-bottom:16px; }

    /* Boutons de navigation */
    .buttons-container { position:absolute; top:20px; right:20px; display:flex; gap:10px; z-index:10; }
    .back-button, .logout-button {
      background:#fff; color:#667eea; border:none; padding:12px 20px; border-radius:12px;
      font-size:0.95rem; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transition:all 0.3s ease-in-out; display:flex; align-items:center; gap:8px;
    }
    .back-button:hover, .logout-button:hover {
      background:#667eea; color:#fff; transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(102,126,234,0.4);
    }

    /* Animation de chargement */
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:translateY(0); }
    }
    .message { animation:fadeIn 0.5s ease-out; }

    /* Responsive */
    @media(max-width:768px){
      .buttons-container { top:10px; right:10px; flex-direction:column; }
      .back-button, .logout-button { padding:10px 16px; font-size:0.85rem; }
      .message-text { padding-left:0; }
      .comment-form { flex-direction:column; }
      .publish-section { padding:20px; }
      .message-header { flex-direction:column; align-items:flex-start; gap:8px; }
      .message-header img { width:45px; height:45px; }
      .container { margin:0 10px; }
      body { padding:20px 10px; }
    }

    @media(max-width:480px){
      h1 { font-size:2rem; }
      .header { margin-bottom:30px; }
      .publish-input { min-height:80px; font-size:0.9rem; }
      .message { padding:15px; }
    }
  </style>
</head>
<body>

<div class="buttons-container">
  <button class="back-button" onclick="window.location.href='/menu/menu.html'">
    <span>‚¨Ö</span> Retour
  </button>
  <button class="logout-button" id="btnLogout">
    <span>üö™</span> D√©connexion
  </button>
</div>

<div class="header">
  <h1>Fil d'Actualit√©</h1>
  <div class="subtitle">Partagez et √©changez avec la communaut√©</div>
</div>

<div class="container">
  <!-- Section pour publier un nouveau message -->
  <div class="publish-section">
    <div class="publish-form">
      <textarea
              class="publish-input"
              id="newMessageInput"
              placeholder="üí≠ Quoi de neuf ? Partagez vos pens√©es avec la communaut√©..."
              maxlength="500"
      ></textarea>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <small style="color:#9ca3af; font-size:0.8rem;">
          <span id="charCount">0</span>/500 caract√®res
        </small>
        <button class="publish-submit" id="publishButton">
          üì§ Publier
        </button>
      </div>
    </div>
  </div>

  <div class="messages-header">
    <span>üí¨ Discussions r√©centes</span>
  </div>

  <div id="messages">
    <div class="loading">
      <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
        <div style="width:20px; height:20px; border:2px solid #667eea; border-top:2px solid transparent; border-radius:50%; animation:spin 1s linear infinite;"></div>
        Chargement des publications...
      </div>
    </div>
  </div>
</div>

<script>
  const token = localStorage.getItem('accessToken');

  // V√©rification d'authentification
  if (!token) {
    alert('Vous devez √™tre connect√© pour acc√©der au fil d\'actualit√©');
    window.location.href = '/connection/connection.html';
  }

  // Variables globales
  let currentUserId = null;
  let currentUserData = null;

  // Compteur de caract√®res
  document.getElementById('newMessageInput').addEventListener('input', function() {
    const charCount = this.value.length;
    document.getElementById('charCount').textContent = charCount;

    if (charCount > 450) {
      document.getElementById('charCount').style.color = '#ef4444';
    } else if (charCount > 400) {
      document.getElementById('charCount').style.color = '#f59e0b';
    } else {
      document.getElementById('charCount').style.color = '#9ca3af';
    }
  });

  // R√©cup√©rer l'utilisateur courant
  async function getCurrentUser() {
    try {
      const response = await fetch('/api/users/me', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!response.ok) throw new Error('Erreur lors de la r√©cup√©ration du profil');
      const userData = await response.json();
      currentUserId = userData.id;
      currentUserData = userData;
      return userData;
    } catch (error) {
      console.error('Erreur:', error);
      return null;
    }
  }

  // Formater les dates
  function formatDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffMins < 1) return '√Ä l\'instant';
    if (diffMins < 60) return `Il y a ${diffMins} min`;
    if (diffHours < 24) return `Il y a ${diffHours} h`;
    if (diffDays === 1) return 'Hier';
    if (diffDays < 7) return `Il y a ${diffDays} j`;

    return date.toLocaleDateString('fr-FR', {
      day:'2-digit',
      month:'2-digit',
      year:'numeric',
      hour:'2-digit',
      minute:'2-digit'
    });
  }

  // Charger les messages et commentaires
  async function fetchMessages() {
    try {
      const response = await fetch('/api/messages', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!response.ok) throw new Error('Erreur API');
      const messages = await response.json();
      const container = document.getElementById('messages');
      container.innerHTML = '';

      if (messages.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size:3rem; margin-bottom:16px;">üå±</div>
            <h3 style="color:#667eea; margin-bottom:8px;">Aucune publication</h3>
            <p>Soyez le premier √† partager quelque chose !</p>
          </div>
        `;
        return;
      }

      // Trier les messages du plus r√©cent au plus ancien
      const messagesTries = messages.sort((a, b) => {
        return new Date(b.heureMessage) - new Date(a.heureMessage);
      });

      // Charger les commentaires pour chaque message
      for (const msg of messagesTries) {
        await afficherMessageAvecCommentaires(msg, container);
      }

    } catch(err) {
      console.error(err);
      document.getElementById('messages').innerHTML = `
        <div class="error">
          <div style="font-size:2rem; margin-bottom:10px;">‚ö†Ô∏è</div>
          <p>Impossible de charger les publications</p>
          <button onclick="fetchMessages()" style="margin-top:15px; padding:8px 16px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer;">
            R√©essayer
          </button>
        </div>
      `;
    }
  }

  // Afficher un message avec ses commentaires
  async function afficherMessageAvecCommentaires(msg, container) {
    try {
      // R√©cup√©rer les commentaires pour ce message
      const commentsResponse = await fetch(`/api/commentaires/message/${msg.id}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });

      let comments = [];
      if (commentsResponse.ok) {
        const commentsData = await commentsResponse.json();
        comments = commentsData.commentaires || [];

        // Trier les commentaires du plus r√©cent au plus ancien
        comments.sort((a, b) => {
          return new Date(b.createdAt) - new Date(a.createdAt);
        });
      }

      const div = document.createElement('div');
      div.className = 'message';
      const photoUrl = msg.photoUrl || "/photos/default.png";

      div.innerHTML = `
        <div class="message-header">
          <img src="${photoUrl}" alt="photo de ${msg.username}" onerror="this.src='/photos/default.png'">
          <div class="user-info">
            <div class="username">${msg.username}</div>
            <div class="time">${formatDate(msg.heureMessage)}</div>
          </div>
        </div>
        <div class="message-text">${msg.intituleMessage}</div>

        <div class="comments-section">
          <div class="comments-header">
            <span>üí¨ Commentaires</span>
            <span class="comment-count">${comments.length}</span>
          </div>

          <div class="comment-form">
            <textarea
              class="comment-input"
              placeholder="‚úèÔ∏è Ajouter un commentaire..."
              data-message-id="${msg.id}"
              maxlength="300"
            ></textarea>
            <button class="comment-submit" data-message-id="${msg.id}">Commenter</button>
          </div>

          <div class="comments-list" id="comments-${msg.id}">
            ${comments.length > 0 ? comments.map(comment => `
              <div class="comment">
                <img src="${comment.userPhotoUrl || '/photos/default.png'}" alt="photo de ${comment.username}" class="comment-avatar" onerror="this.src='/photos/default.png'">
                <div class="comment-content">
                  <div class="comment-author">${comment.username}</div>
                  <div class="comment-text">${comment.texte}</div>
                  <div class="comment-time">${formatDate(comment.createdAt)}</div>
                </div>
              </div>
            `).join('') : `
              <div style="text-align:center; padding:20px; color:#9ca3af; font-size:0.9rem;">
                Aucun commentaire pour le moment
              </div>
            `}
          </div>
        </div>
      `;

      container.appendChild(div);

      // Ajouter les √©v√©nements pour le commentaire
      const submitBtn = div.querySelector('.comment-submit');
      const textarea = div.querySelector('.comment-input');

      submitBtn.addEventListener('click', () => ajouterCommentaire(msg.id, textarea, submitBtn));
      textarea.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          ajouterCommentaire(msg.id, textarea, submitBtn);
        }
      });

    } catch (error) {
      console.error('Erreur lors du chargement des commentaires:', error);
    }
  }

  // Publier un nouveau message
  async function publierMessage() {
    const messageInput = document.getElementById('newMessageInput');
    const publishButton = document.getElementById('publishButton');
    const messageText = messageInput.value.trim();

    if (!messageText) {
      alert('Veuillez √©crire un message avant de publier');
      return;
    }

    if (messageText.length > 500) {
      alert('Le message ne peut pas d√©passer 500 caract√®res');
      return;
    }

    if (!currentUserId) {
      alert('Erreur: Impossible de r√©cup√©rer votre identifiant');
      return;
    }

    publishButton.disabled = true;
    publishButton.textContent = 'Publication...';

    try {
      const response = await fetch(`/api/messages/user/${currentUserId}`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(messageText)
      });

      if (response.ok) {
        const newMessage = await response.json();
        messageInput.value = '';
        document.getElementById('charCount').textContent = '0';
        document.getElementById('charCount').style.color = '#9ca3af';

        // Recharger les messages
        await fetchMessages();

        // Faire d√©filer vers le haut pour voir le nouveau message
        document.getElementById('messages').scrollTop = 0;

      } else {
        const error = await response.json();
        alert('Erreur: ' + (error.error || 'Impossible de publier le message'));
      }
    } catch (error) {
      console.error('Erreur:', error);
      alert('Erreur r√©seau lors de la publication du message');
    } finally {
      publishButton.disabled = false;
      publishButton.textContent = 'üì§ Publier';
    }
  }

  // Ajouter un commentaire
  async function ajouterCommentaire(messageId, textarea, submitBtn) {
    const texte = textarea.value.trim();
    if (!texte) {
      alert('Veuillez √©crire un commentaire');
      return;
    }

    if (texte.length > 300) {
      alert('Le commentaire ne peut pas d√©passer 300 caract√®res');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Envoi...';

    try {
      const response = await fetch(`/api/commentaires/message/${messageId}`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ texte })
      });

      if (response.ok) {
        const result = await response.json();
        textarea.value = '';

        // Recharger les messages pour afficher le nouveau commentaire
        await fetchMessages();
      } else {
        const error = await response.json();
        alert('Erreur: ' + (error.error || 'Impossible d\'ajouter le commentaire'));
      }
    } catch (error) {
      console.error('Erreur:', error);
      alert('Erreur r√©seau lors de l\'ajout du commentaire');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Commenter';
    }
  }

  // Initialisation
  window.addEventListener('DOMContentLoaded', async () => {
    // R√©cup√©rer l'utilisateur courant d'abord
    await getCurrentUser();
    // Puis charger les messages
    await fetchMessages();
  });

  // √âv√©nements pour la publication
  document.getElementById('publishButton').addEventListener('click', publierMessage);
  document.getElementById('newMessageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && e.ctrlKey) {
      e.preventDefault();
      publierMessage();
    }
  });

  // D√©connexion
  document.getElementById('btnLogout').addEventListener('click', async () => {
    const refreshToken = localStorage.getItem('refreshToken');
    if (!refreshToken) return;

    try {
      const res = await fetch('/api/auth/logout', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ refreshToken })
      });
      if(res.ok) {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        alert('D√©connexion r√©ussie');
        window.location.href = '/connection/connection.html';
      } else {
        alert('Erreur lors de la d√©connexion');
      }
    } catch(err) {
      alert('Erreur r√©seau lors de la d√©connexion');
    }
  });

  // Animation CSS pour le spinner
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
</script>

</body>
</html>